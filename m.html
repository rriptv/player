<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto ClearKey Player</title>
    
    <script src="https://cdn.jsdelivr.net/npm/shaka-player@4.3.5/dist/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shaka-player@4.3.5/dist/controls.min.css">
    
    <style>
        body, html {
            width: 100%;
            height: 100vh;
            background: #000;
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #video {
            width: 100%;
            height: 100%;
        }

        /* Loading Spinner */
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            color: white;
            font-family: sans-serif;
            text-align: center;
        }
        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner"></div>
        <div id="status-text">Loading...</div>
    </div>

    <div class="player-container" data-shaka-player-container style="width:100%; height:100%">
        <video data-shaka-player id="video" autoplay></video>
    </div>

    <script>
        async function init() {
            const statusText = document.getElementById('status-text');
            const loading = document.getElementById('loading');

            // 1. ADVANCED URL PARSING
            const urlParams = new URLSearchParams(window.location.search);
            
            // Get the ID (MPD) and the License Key
            let rawId = urlParams.get('id');
            let keyParam = urlParams.get('drmLicense');

            let manifestUri = "";
            let clearKeys = {};

            if (rawId) {
                // CLEAN UP THE ID:
                // The browser might split the URL at '&', but it usually keeps the '|' attached to the first part.
                // We split by '|' to separate the Link from the garbage.
                if (rawId.includes('|')) {
                    const parts = rawId.split('|');
                    manifestUri = parts[0].trim(); // Takes the clean MPD link

                    // If 'drmLicense' wasn't found as a main parameter, check if it's hidden inside the pipe string
                    if (!keyParam && parts[1]) {
                        // Create a dummy URL search to parse the string after the pipe
                        const internalParams = new URLSearchParams(parts[1]);
                        keyParam = internalParams.get('drmLicense');
                    }
                } else {
                    manifestUri = rawId.trim();
                }

                // PROCESS THE KEY (Format: kid:key)
                if (keyParam) {
                    const keyParts = keyParam.split(':');
                    if (keyParts.length === 2) {
                        clearKeys[keyParts[0]] = keyParts[1];
                        console.log("Auto-detected Key:", keyParts[0]);
                    }
                }
            } else {
                statusText.innerText = "Error: ?id= parameter is missing";
                return;
            }

            if (!manifestUri) {
                statusText.innerText = "Error: No MPD Link found";
                return;
            }

            // 2. INITIALIZE SHAKA PLAYER
            const video = document.getElementById('video');
            const ui = video['ui'];
            const controls = ui.getControls();
            const player = controls.getPlayer();

            // Configure DRM
            if (Object.keys(clearKeys).length > 0) {
                player.configure({
                    drm: {
                        clearKeys: clearKeys
                    }
                });
            } else {
                console.log("No DRM keys found, attempting to play without keys...");
            }

            // Error Handling
            player.addEventListener('error', (event) => {
                console.error('Shaka Error', event.detail);
                statusText.innerText = "Error: " + event.detail.code;
            });

            // Buffering Event
            player.addEventListener('buffering', (event) => {
                if (event.buffering) {
                    loading.classList.remove('hidden');
                    statusText.innerText = "Buffering...";
                } else {
                    loading.classList.add('hidden');
                }
            });

            // 3. LOAD THE VIDEO
            try {
                console.log("Loading Manifest:", manifestUri);
                await player.load(manifestUri);
                console.log('Video loaded successfully');
                loading.classList.add('hidden');
            } catch (e) {
                console.error('Load Error', e);
                statusText.innerText = "Load Failed (Check Console)";
            }
        }

        document.addEventListener('shaka-ui-loaded', init);
    </script>
</body>
</html>
