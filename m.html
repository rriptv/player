<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClearKey Player Fixed</title>
    <script src="https://cdn.jsdelivr.net/npm/shaka-player@4.3.5/dist/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shaka-player@4.3.5/dist/controls.min.css">
    
    <style>
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: #000; overflow: hidden;
        }
        .player-container {
            width: 100%; height: 100%;
        }
        #video { width: 100%; height: 100%; }
    </style>
</head>
<body>

    <div class="player-container" data-shaka-player-container>
        <video data-shaka-player id="video" autoplay></video>
    </div>

    <script>
        async function init() {
            const video = document.getElementById('video');
            const ui = video['ui'];
            const controls = ui.getControls();
            const player = controls.getPlayer();

            // 1. Grab parameters
            const urlParams = new URLSearchParams(window.location.search);
            let idParam = urlParams.get('id'); // Get the main ID string
            let licenseParam = urlParams.get('drmLicense'); // Try to get license if browser separated it

            let manifestUri = "";
            let clearKeys = {};

            if (idParam) {
                // CLEAN THE URL: Remove the pipe "|" and everything after it from the main URL
                if (idParam.includes('|')) {
                    const parts = idParam.split('|');
                    manifestUri = parts[0]; // Keep only the MPD link

                    // If browser didn't split it (e.g. if encoded), check the second part for params
                    if (!licenseParam && parts[1]) {
                        const subParams = new URLSearchParams(parts[1]);
                        licenseParam = subParams.get('drmLicense');
                    }
                } else {
                    manifestUri = idParam;
                }

                // 2. Process the License Key (kid:key)
                if (licenseParam) {
                    const keyParts = licenseParam.split(':');
                    if (keyParts.length === 2) {
                        clearKeys[keyParts[0]] = keyParts[1];
                        console.log("Key found:", keyParts[0]);
                    }
                }
            }

            // 3. Configure Player
            if (Object.keys(clearKeys).length > 0) {
                player.configure({
                    drm: { clearKeys: clearKeys }
                });
            } else {
                console.warn("No DRM keys found in URL.");
            }

            // 4. Load Video
            try {
                await player.load(manifestUri);
                console.log('Video loaded');
            } catch (e) {
                console.error('Error loading video', e);
            }
        }

        document.addEventListener('shaka-ui-loaded', init);
    </script>
</body>
</html>
