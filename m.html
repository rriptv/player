<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClearKey Player</title>
    
    <script src="https://cdn.jsdelivr.net/npm/shaka-player@4.3.5/dist/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shaka-player@4.3.5/dist/controls.min.css">
    
    <style>
        body, html {
            width: 100%;
            height: 100vh;
            background: #000;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        .player-container {
            width: 100%;
            height: 100%;
        }
        #video {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>

    <div class="player-container" data-shaka-player-container>
        <video data-shaka-player id="video" autoplay></video>
    </div>

    <script>
        async function init() {
            // 1. Get the URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const idParam = urlParams.get('id');

            let manifestUri = "";
            let clearKeys = {};

            if (idParam) {
                // Split the ID parameter by the pipe symbol '|'
                // Format: MPD_URL|drmScheme=clearkey&drmLicense=KID:KEY
                const parts = idParam.split('|');
                
                // The first part is the MPD URL
                manifestUri = parts[0];

                // If there is a second part, parse it for keys
                if (parts[1]) {
                    const drmParams = new URLSearchParams(parts[1]);
                    const drmLicense = drmParams.get('drmLicense'); // "kid:key"

                    if (drmLicense) {
                        const keyParts = drmLicense.split(':');
                        if (keyParts.length === 2) {
                            const keyId = keyParts[0];
                            const key = keyParts[1];
                            clearKeys[keyId] = key;
                        }
                    }
                }
            } else {
                console.error("No 'id' parameter found in URL.");
                return;
            }

            // 2. Initialize Shaka Player
            const video = document.getElementById('video');
            const ui = video['ui'];
            const controls = ui.getControls();
            const player = controls.getPlayer();

            // Configure DRM
            if (Object.keys(clearKeys).length > 0) {
                player.configure({
                    drm: {
                        clearKeys: clearKeys
                    }
                });
            }

            // Error listener
            player.addEventListener('error', (event) => {
                console.error('Error code', event.detail.code, 'object', event.detail);
            });

            // 3. Load the video
            try {
                await player.load(manifestUri);
                console.log('Video loaded successfully');
            } catch (e) {
                console.error('Could not load video', e);
            }
        }

        // Wait for Shaka UI to be loaded
        document.addEventListener('shaka-ui-loaded', init);
    </script>
</body>
</html>
